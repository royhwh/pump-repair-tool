<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pump Damage Assessment Tool</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState } = React;

        const PumpRepairTool = () => {
            const [photos, setPhotos] = useState([]);
            const [analysisResults, setAnalysisResults] = useState([]);
            const [isAnalyzing, setIsAnalyzing] = useState(false);
            const [apiKey, setApiKey] = useState('');
            const [showApiInput, setShowApiInput] = useState(false);

            const handlePhotoUpload = (event) => {
                const files = Array.from(event.target.files);
                files.forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const newPhoto = {
                            id: Date.now() + Math.random(),
                            file: file,
                            dataUrl: e.target.result,
                            name: file.name,
                            analyzed: false
                        };
                        setPhotos(prev => [...prev, newPhoto]);
                    };
                    reader.readAsDataURL(file);
                });
            };

            const analyzePhoto = async (photo) => {
                if (!apiKey) {
                    alert('Please enter your Anthropic API key first');
                    setShowApiInput(true);
                    return;
                }

                setIsAnalyzing(true);
                
                try {
                    const base64Data = photo.dataUrl.split(',')[1];
                    
                    const response = await fetch("https://api.anthropic.com/v1/messages", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "x-api-key": apiKey,
                            "anthropic-version": "2023-06-01"
                        },
                        body: JSON.stringify({
                            model: "claude-3-5-sonnet-20241022",
                            max_tokens: 500,
                            messages: [
                                {
                                    role: "user",
                                    content: [
                                        {
                                            type: "image",
                                            source: {
                                                type: "base64",
                                                media_type: photo.file.type,
                                                data: base64Data,
                                            }
                                        },
                                        {
                                            type: "text",
                                            text: `Analyze this industrial pump component photo for damage assessment. Identify the component type, visible damage, and provide a professional description suitable for a repair quote.

Respond ONLY with valid JSON in this format:
{
  "component": "component name (impeller, casing, shaft, bearing, seal, etc.)",
  "damageType": "primary damage type (corrosion, wear, cracking, erosion, cavitation, etc.)",
  "severity": "Minor|Moderate|Severe",
  "description": "Professional 2-3 sentence description of the damage for repair quote"
}`
                                        }
                                    ]
                                }
                            ]
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`API Error: ${response.status} ${response.statusText}`);
                    }

                    const data = await response.json();
                    let responseText = data.content[0].text;
                    responseText = responseText.replace(/```json\n?/g, "").replace(/```\n?/g, "").trim();
                    
                    const analysis = JSON.parse(responseText);
                    
                    setPhotos(prev => prev.map(p => 
                        p.id === photo.id ? { ...p, analyzed: true, analysis } : p
                    ));

                    setAnalysisResults(prev => [...prev, {
                        photoId: photo.id,
                        photoName: photo.name,
                        ...analysis
                    }]);

                } catch (error) {
                    console.error('Analysis failed:', error);
                    alert(`Photo analysis failed: ${error.message}`);
                }
                
                setIsAnalyzing(false);
            };

            const analyzeAllPhotos = async () => {
                const unanalyzedPhotos = photos.filter(photo => !photo.analyzed);
                for (const photo of unanalyzedPhotos) {
                    await analyzePhoto(photo);
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            };

            const generateReport = () => {
                if (analysisResults.length === 0) {
                    alert('Please analyze at least one photo before generating the report.');
                    return;
                }

                const reportContent = `INDUSTRIAL PUMP REPAIR - DAMAGE ASSESSMENT REPORT

Generated: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}

COMPONENT ANALYSIS SUMMARY:
${analysisResults.map((result, index) => `
${index + 1}. ${result.component.toUpperCase()}
   Photo: ${result.photoName}
   Damage Type: ${result.damageType}
   Severity: ${result.severity}
   
   Assessment: ${result.description}
   
   ${'='.repeat(60)}
`).join('')}

SUMMARY OF FINDINGS:
Total Components Analyzed: ${analysisResults.length}
Severe Issues: ${analysisResults.filter(r => r.severity === 'Severe').length}
Moderate Issues: ${analysisResults.filter(r => r.severity === 'Moderate').length}
Minor Issues: ${analysisResults.filter(r => r.severity === 'Minor').length}

COMPONENTS REQUIRING IMMEDIATE ATTENTION:
${analysisResults.filter(r => r.severity === 'Severe').map(r => 
  `• ${r.component} - ${r.damageType}`
).join('\n') || 'None identified'}

RECOMMENDED ACTIONS:
${analysisResults.map(result => {
  const action = result.severity === 'Severe' ? 'REPLACE IMMEDIATELY' :
                result.severity === 'Moderate' ? 'REPAIR/REPLACE' : 'MONITOR/MAINTAIN';
  return `• ${result.component}: ${action}`;
}).join('\n')}

This assessment is based on visual inspection of provided photographs. 
Final repair recommendations should include hands-on inspection by qualified technicians.`;

                const blob = new Blob([reportContent], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `pump-damage-assessment-${new Date().toISOString().split('T')[0]}.txt`;
                a.click();
                URL.revokeObjectURL(url);
            };

            const clearAll = () => {
                setPhotos([]);
                setAnalysisResults([]);
            };

            return (
                <div className="max-w-4xl mx-auto p-6 bg-white min-h-screen">
                    <div className="bg-blue-600 text-white p-6 rounded-t-lg">
                        <h1 className="text-3xl font-bold flex items-center gap-3">
                            🔧 Pump Damage Assessment Tool
                        </h1>
                        <p className="mt-2 text-blue-100">Upload photos → AI analyzes damage → Generate professional report</p>
                    </div>

                    <div className="bg-gray-50 p-6 space-y-6">
                        {/* API Key Input */}
                        {showApiInput && (
                            <div className="bg-yellow-50 border border-yellow-200 p-4 rounded">
                                <h3 className="font-semibold text-yellow-800 mb-2">API Key Required</h3>
                                <p className="text-yellow-700 text-sm mb-3">
                                    To use AI analysis, enter your Anthropic API key. Get one at: 
                                    <a href="https://console.anthropic.com/" target="_blank" className="underline ml-1">
                                        console.anthropic.com
                                    </a>
                                </p>
                                <div className="flex gap-2">
                                    <input
                                        type="password"
                                        placeholder="sk-ant-..."
                                        value={apiKey}
                                        onChange={(e) => setApiKey(e.target.value)}
                                        className="flex-1 px-3 py-2 border rounded"
                                    />
                                    <button
                                        onClick={() => setShowApiInput(false)}
                                        className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                                    >
                                        Save
                                    </button>
                                </div>
                            </div>
                        )}

                        {/* Photo Upload */}
                        <div className="bg-white p-6 rounded border">
                            <h3 className="font-semibold text-gray-800 mb-4 flex items-center gap-2">
                                📷 Upload Component Photos
                            </h3>
                            
                            <label className="flex items-center justify-center w-full h-40 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer hover:border-blue-400 transition-colors">
                                <div className="text-center">
                                    <div className="text-4xl mb-4">📁</div>
                                    <span className="text-lg text-gray-600">Click to upload pump component photos</span>
                                    <p className="text-sm text-gray-500 mt-2">Supports multiple images (JPG, PNG)</p>
                                </div>
                                <input
                                    type="file"
                                    multiple
                                    accept="image/*"
                                    onChange={handlePhotoUpload}
                                    className="hidden"
                                />
                            </label>

                            {photos.length > 0 && (
                                <div className="mt-6">
                                    <div className="flex justify-between items-center mb-4">
                                        <h4 className="font-medium text-gray-700">Uploaded Photos ({photos.length})</h4>
                                        <div className="space-x-2">
                                            {!apiKey && (
                                                <button
                                                    onClick={() => setShowApiInput(true)}
                                                    className="px-4 py-2 bg-yellow-600 text-white rounded hover:bg-yellow-700"
                                                >
                                                    Set API Key
                                                </button>
                                            )}
                                            <button
                                                onClick={analyzeAllPhotos}
                                                disabled={isAnalyzing || photos.every(p => p.analyzed) || !apiKey}
                                                className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 disabled:opacity-50"
                                            >
                                                {isAnalyzing ? 'Analyzing...' : 'Analyze All'}
                                            </button>
                                            <button
                                                onClick={clearAll}
                                                className="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"
                                            >
                                                Clear All
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                                        {photos.map(photo => (
                                            <div key={photo.id} className="border rounded-lg overflow-hidden bg-white">
                                                <img
                                                    src={photo.dataUrl}
                                                    alt={photo.name}
                                                    className="w-full h-32 object-cover"
                                                />
                                                <div className="p-3">
                                                    <p className="text-xs text-gray-600 truncate mb-2">{photo.name}</p>
                                                    {!photo.analyzed ? (
                                                        <button
                                                            onClick={() => analyzePhoto(photo)}
                                                            disabled={isAnalyzing || !apiKey}
                                                            className="w-full px-2 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700 disabled:opacity-50"
                                                        >
                                                            {isAnalyzing ? 'Analyzing...' : 'Analyze'}
                                                        </button>
                                                    ) : (
                                                        <div className="flex items-center text-green-600">
                                                            <span className="text-sm">✓ Analyzed</span>
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* Analysis Results */}
                        {analysisResults.length > 0 && (
                            <div className="bg-white p-6 rounded border">
                                <h3 className="font-semibold text-gray-800 mb-4 flex items-center gap-2">
                                    ⚠️ Damage Analysis Results
                                </h3>
                                
                                <div className="space-y-4">
                                    {analysisResults.map((result, index) => (
                                        <div key={result.photoId} className="border-l-4 border-orange-400 pl-4 py-3 bg-gray-50 rounded-r">
                                            <div className="flex justify-between items-start mb-2">
                                                <h4 className="font-medium text-gray-800 text-lg">{index + 1}. {result.component}</h4>
                                                <span className={`px-3 py-1 text-sm rounded-full font-medium ${
                                                    result.severity === 'Severe' ? 'bg-red-100 text-red-800' :
                                                    result.severity === 'Moderate' ? 'bg-yellow-100 text-yellow-800' :
                                                    'bg-green-100 text-green-800'
                                                }`}>
                                                    {result.severity} {result.damageType}
                                                </span>
                                            </div>
                                            <p className="text-gray-700 mb-2">{result.description}</p>
                                            <p className="text-sm text-gray-500">Photo: {result.photoName}</p>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* Generate Report */}
                        {analysisResults.length > 0 && (
                            <div className="bg-white p-6 rounded border text-center">
                                <button
                                    onClick={generateReport}
                                    className="px-8 py-4 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center gap-3 text-lg font-semibold mx-auto"
                                >
                                    📄 Generate Damage Assessment Report
                                </button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        ReactDOM.render(<PumpRepairTool />, document.getElementById('root'));
    </script>
</body>
</html>